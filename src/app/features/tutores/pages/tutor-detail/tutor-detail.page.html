<div class="max-w-[1000px] mx-auto px-4 py-8">
  <div
    class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8"
  >
    <a
      routerLink="/tutores"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full font-semibold transition-all duration-200 bg-white text-gray-700 border-2 border-gray-200 hover:bg-gray-50 hover:border-orange-500 hover:text-orange-500 group"
    >
      <mat-icon class="transition-transform group-hover:-translate-x-1"
        >arrow_back</mat-icon
      >
      <span>Voltar</span>
    </a>
    <div class="flex gap-3">
      <a
        [routerLink]="['/tutores', tutorId, 'editar']"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full font-semibold text-white transition-all bg-gradient-to-br from-blue-500 to-blue-400 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-blue-500/30"
      >
        <mat-icon>edit</mat-icon>
        <span>Editar</span>
      </a>
      <button
        (click)="confirmDelete()"
        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full font-semibold text-white transition-all bg-gradient-to-br from-red-500 to-red-400 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-red-500/30"
      >
        <mat-icon>delete</mat-icon>
        <span>Excluir</span>
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (facade.loadingDetail$ | async) {
  <mat-progress-bar
    mode="indeterminate"
    class="rounded-full mb-6"
  ></mat-progress-bar>
  } @if (facade.selected$ | async; as tutor) {
  <div
    class="bg-white rounded-3xl p-8 sm:p-10 shadow-xl mb-8 text-center relative overflow-hidden"
  >
    <div
      class="inline-block mb-6 relative hover:scale-105 transition-transform duration-300"
    >
      <img
        [src]="tutor.foto?.url || '/assets/images/placeholder-avatar.png'"
        [alt]="tutor.nome"
        class="w-36 h-36 object-cover rounded-full shadow-2xl"
      />
    </div>
    <div class="max-w-2xl mx-auto">
      <h1
        class="text-3xl sm:text-4xl font-extrabold bg-gradient-to-br from-orange-500 to-orange-400 bg-clip-text text-transparent mb-6"
      >
        {{ tutor.nome | titlecase }}
      </h1>
      <div class="flex flex-wrap justify-center gap-4">
        @if (tutor.telefone) {
        <div
          class="inline-flex items-center gap-2 px-4 py-2 bg-orange-50 rounded-full text-orange-700 font-semibold text-sm cursor-pointer transition-all hover:bg-orange-100 hover:-translate-y-0.5 hover:shadow-sm"
          (click)="confirmPhone(tutor.telefone)"
        >
          <mat-icon class="text-orange-500 text-lg w-5 h-5">phone</mat-icon>
          <span>{{ tutor.telefone }}</span>
        </div>
        } @if (tutor.email) {
        <div
          class="inline-flex items-center gap-2 px-4 py-2 bg-orange-50 rounded-full text-orange-700 font-semibold text-sm cursor-pointer transition-all hover:bg-orange-100 hover:-translate-y-0.5 hover:shadow-sm"
          (click)="confirmEmail(tutor.email)"
        >
          <mat-icon class="text-orange-500 text-lg w-5 h-5">email</mat-icon>
          <span>{{ tutor.email }}</span>
        </div>
        } @if (tutor.endereco) {
        <div
          class="inline-flex items-center gap-2 px-4 py-2 bg-orange-50 rounded-full text-orange-700 font-semibold text-sm cursor-pointer transition-all hover:bg-orange-100 hover:-translate-y-0.5 hover:shadow-sm"
          (click)="openAddressOptions(tutor.endereco)"
        >
          <mat-icon class="text-orange-500 text-lg w-5 h-5"
            >location_on</mat-icon
          >
          <span>{{ tutor.endereco }}</span>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Photo Upload Section -->
  <div class="mb-8">
    <app-photo-upload
      title="Foto de Perfil do Tutor"
      [currentPhotoUrl]="tutor.foto?.url"
      [uploading]="(facade.uploadingPhoto$ | async) ?? false"
      (upload)="uploadTutorPhoto(tutor.id, $event)"
      (delete)="tutor.foto?.id && deleteTutorPhoto(tutor.id, tutor.foto!.id)"
    >
    </app-photo-upload>
  </div>

  <div class="mb-8">
    <div class="bg-white rounded-3xl p-8 shadow-xl">
      <h2 class="flex items-center gap-3 text-xl font-bold text-gray-800 mb-2">
        <mat-icon class="text-orange-500 text-3xl w-8 h-8">add_circle</mat-icon>
        <span>Vincular Novo Pet</span>
      </h2>
      <p class="text-gray-500 text-sm mb-6 ml-10">
        Busque o pet pelo nome para vincular a este tutor
      </p>

      <form
        [formGroup]="linkForm"
        (ngSubmit)="vincular(tutor.id)"
        class="flex flex-col sm:flex-row gap-4 items-end"
      >
        <div class="flex-1 flex flex-col gap-2 w-full">
          <label class="font-semibold text-sm text-gray-700">Buscar Pet</label>
          <input
            type="text"
            formControlName="petSearch"
            [matAutocomplete]="auto"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base transition-all bg-gray-50 focus:outline-none focus:border-orange-500 focus:bg-white focus:ring-4 focus:ring-orange-500/10"
            placeholder="Busque por nome ou raça..."
          />
          <mat-autocomplete
            #auto="matAutocomplete"
            [displayWith]="displayPetName"
          >
            @for (pet of filteredPets$ | async; track pet.id) {
            <mat-option [value]="pet">
              <div class="flex justify-between items-center w-full gap-4">
                <span class="font-bold text-gray-900 text-base flex-1"
                  >{{ pet.nome }}</span
                >
                <span class="text-sm text-orange-500 font-semibold italic"
                  >{{ pet.raca }}</span
                >
              </div>
            </mat-option>
            }
          </mat-autocomplete>
        </div>
        <button
          type="submit"
          [disabled]="linkForm.invalid || (facade.saving$ | async)"
          class="inline-flex items-center justify-center gap-2.5 px-7 py-3.5 bg-gradient-to-br from-orange-500 to-orange-400 text-white border-0 rounded-full text-base font-bold cursor-pointer transition-all disabled:opacity-60 disabled:cursor-not-allowed hover:shadow-lg hover:-translate-y-0.5 sm:w-auto w-full"
        >
          <mat-icon class="text-xl w-5 h-5">link</mat-icon>
          <span
            >{{ (facade.saving$ | async) ? 'Vinculando...' : 'Vincular Pet'
            }}</span
          >
        </button>
      </form>
    </div>
  </div>

  <div class="mb-8">
    <h2 class="flex items-center gap-3 text-2xl font-bold text-gray-800 mb-6">
      <mat-icon class="text-orange-500 text-3xl w-8 h-8">pets</mat-icon>
      <span>Pets Vinculados</span>
      <span
        class="inline-flex items-center justify-center min-w-[2rem] h-8 px-3 bg-gradient-to-br from-orange-500 to-orange-400 text-white rounded-full text-sm font-bold ml-auto"
      >
        {{ (tutor.pets ?? []).length }} {{ (tutor.pets ?? []).length === 1 ?
        'Pet Vinculado' : 'Pets Vinculados' }}
      </span>
    </h2>

    @if ((tutor.pets ?? []).length > 0) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
      @for (pet of tutor.pets; track pet.id) {
      <div
        class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:-translate-y-1 hover:shadow-lg hover:border-orange-200 transition-all duration-300 flex items-start gap-5 relative group"
      >
        <img
          [src]="pet.foto?.url || '/assets/images/placeholder-pet.png'"
          [alt]="pet.nome"
          class="w-20 h-20 rounded-full object-cover shadow-md border-2 border-white"
        />
        <div class="flex-1 min-w-0">
          <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">
            {{ pet.nome | titlecase }}
          </h3>

          <div class="flex items-center gap-2 text-gray-500 text-sm mb-1">
            <mat-icon class="text-gray-400 text-lg w-5 h-5">pets</mat-icon>
            <span>{{ pet.raca | titlecase }}</span>
          </div>
          <div class="flex items-center gap-2 text-gray-500 text-sm mb-2">
            <mat-icon class="text-gray-400 text-lg w-5 h-5">cake</mat-icon>
            <span>{{ pet.idade }} anos</span>
          </div>

          <a
            [routerLink]="['/pets', pet.id]"
            class="inline-flex items-center gap-1.5 mt-3 text-orange-500 font-semibold text-sm group/link hover:text-orange-600 transition-colors"
          >
            <mat-icon
              class="text-lg w-5 h-5 transition-transform group-hover/link:translate-x-1"
              >arrow_forward</mat-icon
            >
            <span>Ver Perfil do Pet</span>
          </a>
        </div>

        <button
          type="button"
          (click)="remover(tutor.id, pet.id, pet.nome)"
          class="absolute top-4 right-4 bg-white text-red-500 w-8 h-8 rounded-full border border-red-100 flex items-center justify-center opacity-0 scale-75 transition-all cursor-pointer group-hover:opacity-100 group-hover:scale-100 hover:bg-red-50 hover:border-red-200 hover:scale-110 md:opacity-0 opacity-100"
          title="Remover vínculo"
        >
          <mat-icon class="text-base w-4 h-4">delete</mat-icon>
        </button>
      </div>
      }
    </div>
    } @else {
    <div
      class="bg-white rounded-2xl p-12 text-center shadow-sm border border-gray-100"
    >
      <mat-icon class="text-6xl w-16 h-16 text-gray-300 mb-4">pets</mat-icon>
      <p class="text-gray-500 text-lg">Nenhum pet vinculado ainda</p>
    </div>
    }
  </div>
  }

  <!-- Error Message -->
  @if (facade.error$ | async; as err) {
  <div
    class="flex items-center gap-3 p-6 bg-red-50 border-l-4 border-red-600 rounded-xl text-red-600 font-medium"
  >
    <mat-icon>error</mat-icon>
    <span>{{ err }}</span>
  </div>
  }
</div>
